<script type="text/x-handlebars-template" id="Graph-template">
    <div class="Graph-box" id="Graph-box">
        <div class="tools">
            <div class="tool info-box" href="#Graph-tool-relation">
                <span class="info-box-icon"><i class="fa fa-search"></i></span>
                <span class="info-box-number">关系图</span>
            </div>
            <div class="tool info-box" href="#Graph-tool-display">
                <span class="info-box-icon"><i class="fa fa-star-half-empty"></i></span>
                <span class="info-box-number">显示/隐藏</span>
            </div>
            <div class="tool info-box" href="#Graph-tool-layout">
                <span class="info-box-icon"><i class="iconfont icon-topology"></i></span>
                <span class="info-box-number">布局</span>
            </div>
        </div>
        <div class="secondMenu" id="Graph-tool-relation">
            <ul class="list-group">
              <li class="list-group-item clicked" data-relation="0">关系图</li>
              <li class="list-group-item" data-relation="1">部署关系图</li>
              <li class="list-group-item" data-relation="2">通信关系图</li>
              <li class="list-group-item" data-relation="3">物理连接关系图</li>
          </ul>
        </div>
        <div class="secondMenu" id="Graph-tool-display">
            <li class="list-group-item">显示节点：</li>
            <ul class="list-group">
                <!-- <li class="list-group-item">
                    <input type="checkbox">
                    <i class="fa fa-star-half-empty"></i>
                    <span>3 </span>
                    <span>数据库</span>
                </li> -->
            </ul>
        </div>
        <div class="secondMenu" id="Graph-tool-layout">
            <ul class="list-group">
              <li class="list-group-item clicked" data-layout="0">拓扑</li>
              <li class="list-group-item" data-layout="1">应用层级</li>
              <li class="list-group-item" data-layout="2">环形</li>
          </ul>
        </div>
        <div id="Graph"></div>
    </div>
</script>

<script>
    (function (window, factory) {
        if (typeof define === 'function' && define.amd) {
            // AMD
            define(factory);
        } else if (typeof exports === 'object') {
            // Node, CommonJS-like
            module.exports = factory();
        } else {
            // Browser globals (window is window)
            window.Graph = factory();
        };
    }(window, function () {
        var Record = {
            params:{}
        }

        // 在dom中载入基本的内容
        function renderBasic($dom){
            $dom.append( $('#Graph-template').html() );
        }
        function render(params){
            params.relation = params.relation || 0;
            // 记录参数
            Record.params = params;
            getData(loadData);
            if (Record.diagram){
                Record.diagram.div = null;
            }
            initTheDiagram();
        };
        // 获取数据
        function getData(callback){
            var url = 'ITSourceTopo/showTopo';
            // todo : 以后删除
            if ( window.UrlConfig = 'frontEnd' ){
                switch(Record.params.relation){
                    case '0':{
                        break;
                    }
                    case '1':{
                        url = 'ITSourceTopo/showTopoDeploy'
                        break;
                    }
                    case '2':{
                        url = 'ITSourceTopo/showTopoCon'
                        break;
                    }
                    case '3':{
                        url = 'ITSourceTopo/showTopoPhy'
                        break;
                    }
                }
            }
            fetchData(url,'json',Record.params,{
                success:function(res){
                    if (callback) {
                        callback(res.data);
                    }
                }
            });
        }
        // 载入数据
        function loadData(data){
            loadDataToDiagram(data);
            loadDataToTool(data.count);
        }
        function loadDataToDiagram(data){
            var newData = new Object();
            newData['class'] = 'go.GraphLinksModel';
            newData['copiesArrays'] = true;
            newData['copiesArrayObjects'] = true;
            newData['linkFromPortIdProperty'] = 'fromPort';
            newData['linkToPortIdProperty'] = 'toPort';
            newData['nodeDataArray'] = data.nodeDataArray;
            newData['linkDataArray'] = data.linkDataArray || [];
            $.each(data.nodeDataArray,function(i,perNode){
                perNode.key = perNode.id;
                perNode.source = getStatusItem('devices', perNode.ciCode ).image;
            });
            var blackRel = [];
            for (var i = newData['linkDataArray'].length - 1; i >= 0; i--) {
                var perLink = newData['linkDataArray'][i];
                switch(perLink.relation){
                    case 'green' :{
                        perLink.color = '#00a65a';
                        break;
                    }
                    case 'black' :{
                        perLink.color = '#000';
                        break;
                    }
                    case 'orange' :{
                        perLink.color = '#f39c12';
                        break;
                    }
                    case 'yellow' :{
                        perLink.color = 'yellow';
                        break;
                    } 
                    default :{
                        break;
                    }
                };
                if (Record.params.relation == '0' && perLink.relation == 'black') {
                    blackRel.push( newData['linkDataArray'].splice(i,1)[0] );
                }
            };
            var diag = Record.diagram;
            diag.model = new go.Model.fromJson(newData);
            if (Record.params.relation == '0') {
                setTimeout(function(){
                    diag.startTransaction('load');
                    diag.model.addLinkDataCollection(blackRel);
                    diag.commitTransaction('load');
                },2000)
            }
            
        }
        function loadDataToTool(count){
            var dom = $('#Graph-tool-display .list-group');
            dom.html('');
            $.each(count,function(i,perType){
                var status = getStatusItem('devices',perType.ciCode);
                dom.append('<li class="list-group-item clicked">'+
                    '<i class="iconfont '+status.icon+'"></i>'+
                    '<span>'+ perType.sum +' </span>'+
                    '<span>'+ status.text +'</span>'+
                    '</li>');
            });
        };
        function setLayout(btn){
            var diag = Record.diagram; 
            diag.startTransaction('setDiagramLayout');
            if (btn.innerText == '拓扑') {
                diag.layout = go.GraphObject.make(go.ForceDirectedLayout);
            } else if (btn.innerText == '应用层级'){
                diag.layout = go.GraphObject.make(go.TreeLayout,{  
                    angle: 90,
                    // nodeSpacing: 20,
                    // layerSpacing: 60,
                });
            } else if (btn.innerText == '环形'){
                diag.layout = go.GraphObject.make(go.CircularLayout);
            }
            diag.commitTransaction('setDiagramLayout');
        }

        function initTheDiagram(){

            var $ = go.GraphObject.make;  
            myDiagram =
            $(go.Diagram, "Graph",
            {
                "toolManager.hoverDelay":10,
                "toolManager.mouseWheelBehavior": go.ToolManager.WheelZoom,
                initialAutoScale : go.Diagram.Uniform,
                initialContentAlignment: go.Spot.Center,
                layout: $(go.TreeLayout,{  
                    angle: 90,
                    // tree
                    nodeSpacing: 20,
                    layerSpacing: 40,
                    isOngoing:false,
                    // isInitial:false
                })
                // layout: $(go.ForceDirectedLayout ,{
                //     defaultSpringLength : 90
                // })
            });

            myDiagram.nodeTemplate =
            $(go.Node, "Horizontal",
                new go.Binding("location", "loc"),
                {   locationSpot: go.Spot.Center,
                    toEndSegmentLength: 30,
                    fromEndSegmentLength: 30
                },
                { 
                    selectionChanged: function(){} 
                },
                $(go.Panel,'Vertical',
                    $(go.Panel,'Spot',
                        // 图片背景
                        // $(go.Panel, "Auto",
                        //     $(go.Shape, 
                        //     {
                        //         width:80,
                        //         height:80,
                        //         figure:'Circle',
                        //         fill: "#f1f1f1",
                        //         stroke: null
                        //     },
                        //     new go.Binding("fill", "type", genderBrushConverter)
                        //     )),
                        $(go.Picture, {
                            source:'dist/img/avatar.png',
                            width: 48,
                            height: 48,
                            margin:5
                        }, new go.Binding("source")),
                        $("TreeExpanderButton",{
                            alignment: go.Spot.TopRight,
                            width:20,height:20,scale:1
                            // mouseEnter:function(e, obj) { obj.scale = 1.4; },
                            // mouseLeave:function(e, obj) { obj.scale = 1; }
                        })
                        ),
                    $(go.TextBlock,{
                        font: "bold 16px Helvetica, bold Arial, sans-serif",
                        stroke: "#000" 
                    },new go.Binding("text", "resName"))
                    )

                );


            myDiagram.linkTemplate =
            $(go.Link,
            {
                layoutConditions: go.Part.LayoutNone,
                // routing: go.Link.Normal,
                // 该属性设置曲线 且routing为Orthogonal时会夸张曲
                curve: go.Link.Bezier,
                reshapable:true,
                // 直角
                // routing: go.Link.Orthogonal,
                // curve: go.Link.JumpOver,
                // 该值设置直角程度,需加上 JumpOver
                // corner: 5
            },
            {
                mouseHover:function(e,obj){
                    myDiagram.startTransaction('setDiagramLayout');
                    myDiagram.model.setDataProperty(obj.data,"linkState",'sher');
                    myDiagram.commitTransaction('setDiagramLayout');
                },
                mouseLeave:function(e,obj){
                    myDiagram.startTransaction('setDiagramLayout');
                    myDiagram.model.setDataProperty(obj.data,"linkState",'');
                    myDiagram.commitTransaction('setDiagramLayout');
                }
            },
            $(go.Shape,
                { name: "OBJSHAPE",stroke: "#00c0ef",strokeWidth: 2 },
                new go.Binding('stroke','color')),
            $(go.Shape,
                { name: "ARWSHAPE", toArrow: "Standard" ,stroke: "#00c0ef" ,fill:'#00c0ef',scale:1.3,visible:true},
                new go.Binding('stroke','color'),
                new go.Binding('fill','color'),
                new go.Binding('visible')),
            $(go.TextBlock, {
                // border:'1px solid',
                segmentOffset: new go.Point(0, 20),
                isMultiline:true,
                maxLines:4,
                wrap:go.TextBlock.WrapDesiredSize,
                overflow:go.TextBlock.OverflowEllipsis,
                // textAlign: "left",
                font: "16px Tahoma",
                stroke: "#333333",
                visible: true,
                editable: false 
            }, new go.Binding("text","linkState"))
            );

            function genderBrushConverter(type) {
                return "orange";
            }
            
            Record.diagram = myDiagram;
        }

        // 注册事件
        $('body').on('click','#Graph-tool-relation .list-group-item',function(){
            $(this).addClass('clicked');
            $(this).siblings().removeClass('clicked');
            Record.params.relation = $(this).attr('data-relation');
            getData(loadData);
        });
        $('body').on('click','#Graph-box .tools .tool',function(){
            $(this).siblings().each(function(i,perTool){
                $( $(perTool).attr('href') ).removeClass('show');
            });
            $( $(this).attr('href') ).toggleClass('show');
            
        });
        $('body').on('click','#Graph-tool-display .list-group .list-group-item',function(){
            $(this).toggleClass('clicked');
        });
        $('body').on('click','#Graph-tool-layout .list-group .list-group-item',function(){
            $(this).addClass('clicked');
            $(this).siblings().removeClass('clicked');
            setLayout(this);
        });
        // $(window).on('resize',function(){
        //     $('#Graph-box').height($(window).height() - 280 );
        // })
        return {
            render:render,
            renderBasic:renderBasic
        };
    }));

</script>

<script src="plugins/gojs-1.5.8/go-no.js"></script>
